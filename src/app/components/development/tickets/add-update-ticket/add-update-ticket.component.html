<div class="container-fluid p-0">
  <div class="row justify-content-center mx-3">
    <div class="col-md-12 m-4">
      <div class="card p-3">
        <div class="card-header d-flex justify-content-between p-3">
          <strong class="text-dark fs-5"
            >{{ isEdit ? " Edit" : "Add " }} Ticket</strong
          >
          <button
            type="button"
            class="btn btn-secondary ms-3 px-4 btn-sm fw-bold"
            (click)="goToback()"
          >
            Cancel
          </button>
        </div>
        <!-- Updated Form UI for TicketForm -->
        <div class="card-body">
          <form [formGroup]="TicketForm">
            <div class="row">
              <div class="col-md-4">
                <label class="mb-2"
                  >Company <span class="text-danger">*</span></label
                >
                <select
                  class="form-control"
                  formControlName="customer_id"
                  (change)="onCompanyChange($event)"
                  [ngClass]="{
                    'is-invalid':
                      controls['customer_id'].invalid &&
                      (controls['customer_id'].dirty ||
                        controls['customer_id'].touched)
                  }"
                >
                  <option value="" disabled selected hidden>
                    Select Company
                  </option>
                  <option
                    *ngFor="let item of allTicketEmployeeStatusList"
                    [value]="item.customer_id"
                  >
                    {{ item.company_name | titlecase }}
                  </option>
                </select>
                <div
                  class="text-danger"
                  *ngIf="
                    controls['customer_id'].invalid &&
                    (controls['customer_id'].touched ||
                      controls['customer_id'].dirty)
                  "
                >
                  <small>Please select a Company.</small>
                </div>
              </div>
              <!-- <div class="col-md-4 mb-3">
                <label
                  class="mb-2 d-flex justify-content-between align-items-center"
                >
                  <span>Service <span class="text-danger">*</span></span>
                </label>
                <mat-select
                  formControlName="service_id"
                  placeholder="Select Service"
                  class="form-control theme-input"
                  [ngClass]="{
                    'is-invalid':
                      controls['service_id'].invalid &&
                      (controls['service_id'].dirty ||
                        controls['service_id'].touched)
                  }"
                >
                  <mat-option>
                    <ngx-mat-select-search
                      [(ngModel)]="searchServiceValue"
                      [ngModelOptions]="{ standalone: true }"
                      (input)="filterService()"
                      placeholderLabel="Search Service"
                      noEntriesFoundLabel="No result found"
                    ></ngx-mat-select-search>
                  </mat-option>

                  <mat-option
                    *ngFor="let source of filteredServiceList"
                    [value]="source.service_id"
                  >
                    {{ source.service_name | titlecase }}
                  </mat-option>
                </mat-select>
                <div
                  class="text-danger"
                  *ngIf="
                    controls['service_id'].invalid &&
                    (controls['service_id'].touched ||
                      controls['service_id'].dirty)
                  "
                >
                  <small>Please select a Service.</small>
                </div>
              </div>  -->
              <div class="col-md-4">
                <label class="mb-2"
                  >Department <span class="text-danger">*</span></label
                >
                <select
                  class="form-control"
                  formControlName="department_id"
                  (change)="onDepartmentAgentChange($event)"
                  [ngClass]="{
                    'is-invalid':
                      controls['department_id'].invalid &&
                      (controls['department_id'].dirty ||
                        controls['department_id'].touched)
                  }"
                >
                  <option value="" disabled selected hidden>
                    Select Department
                  </option>
                  <option
                    *ngFor="let item of allDepartmentList"
                    [value]="item.department_id"
                  >
                    {{ item.department_name | titlecase }}
                  </option>
                </select>
                <div
                  class="text-danger"
                  *ngIf="
                    controls['department_id'].invalid &&
                    (controls['department_id'].touched ||
                      controls['department_id'].dirty)
                  "
                >
                  <small>Please select a Department.</small>
                </div>
              </div>
              <!-- Ticket Category -->
              <div class="col-md-4 mb-3">
                <label
                  class="mb-2 d-flex justify-content-between align-items-center"
                >
                  <span>Category <span class="text-danger">*</span></span>
                </label>
                <mat-select
                  formControlName="ticket_category_id"
                  placeholder="Select category"
                  class="form-control theme-input"
                  [ngClass]="{
                    'is-invalid':
                      controls['ticket_category_id'].invalid &&
                      (controls['ticket_category_id'].dirty ||
                        controls['ticket_category_id'].touched)
                  }"
                >
                  <mat-option>
                    <ngx-mat-select-search
                      [(ngModel)]="searchCategoryValue"
                      [ngModelOptions]="{ standalone: true }"
                      (input)="filterCategory()"
                      placeholderLabel="Search Category"
                      noEntriesFoundLabel="No result found"
                    ></ngx-mat-select-search>
                  </mat-option>

                  <mat-option
                    *ngFor="let source of filteredCategoryList"
                    [value]="source.ticket_category_id"
                  >
                    {{ source.name | titlecase }}
                  </mat-option>
                </mat-select>
                <div
                  class="text-danger"
                  *ngIf="
                    controls['ticket_category_id'].invalid &&
                    (controls['ticket_category_id'].touched ||
                      controls['ticket_category_id'].dirty)
                  "
                >
                  <small>Please select a Category.</small>
                </div>
              </div>

              <!-- <div class="col-md-4">
                <label class="mb-2"
                  >Department <span class="text-danger">*</span></label
                >
                <select
                  class="form-control"
                  formControlName="department_id"
                  [ngClass]="{
                    'is-invalid':
                      controls['department_id'].invalid &&
                      (controls['department_id'].dirty ||
                        controls['department_id'].touched)
                  }"
                >
                  <option value="" disabled selected hidden>
                    Select Department
                  </option>
                  <option
                    *ngFor="let item of allDepartmentList"
                    [value]="item.department_id"
                  >
                    {{ item.department_name | titlecase }}
                  </option>
                </select>
                 <div
                  class="text-danger"
                  *ngIf="
                    controls['department_id'].invalid &&
                    (controls['department_id'].touched ||
                      controls['department_id'].dirty)
                  "
                >
                  <small>Please select a Department.</small>
                </div>
              </div> -->

              <!-- Priority -->
              <div class="col-md-4 mb-3">
                <label class="mb-2"
                  >Priority <span class="text-danger">*</span></label
                >
                <select
                  class="form-control"
                  formControlName="priority_id"
                  [ngClass]="{
                    'is-invalid':
                      controls['priority_id'].invalid &&
                      (controls['priority_id'].dirty ||
                        controls['priority_id'].touched)
                  }"
                >
                  <option value="" disabled selected hidden>
                    Select Priority
                  </option>
                  <option
                    *ngFor="let item of allPriorityList"
                    [value]="item.priority_id"
                  >
                    {{ item.name | titlecase }}
                  </option>
                </select>
                <div
                  class="text-danger"
                  *ngIf="
                    controls['priority_id'].invalid &&
                    (controls['priority_id'].touched ||
                      controls['priority_id'].dirty)
                  "
                >
                  <small>Please select a Priority.</small>
                </div>
              </div>

              <!-- subject -->
              <div class="col-md-4 mb-3">
                <label class="mb-2"
                  >Subject<span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  formControlName="subject"
                  placeholder="Subject"
                  [ngClass]="{
                    'is-invalid':
                      controls['subject'].invalid &&
                      (controls['subject'].dirty || controls['subject'].touched)
                  }"
                />
                <div
                  class="text-danger"
                  *ngIf="
                    controls['subject'].invalid &&
                    (controls['subject'].dirty || controls['subject'].touched)
                  "
                >
                  <div *ngIf="controls['subject'].errors?.['required']">
                    <small>Subject is Required</small>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <label class="mb-2">Ticket Status</label>
                <select
                  class="form-control"
                  formControlName="ticket_status"
                  [ngClass]="{
                    'is-invalid':
                      controls['ticket_status'].invalid &&
                      (controls['ticket_status'].dirty ||
                        controls['ticket_status'].touched)
                  }"
                >
                  <option value="" disabled hidden>Select Status</option>
                  <option value="Accepted">Accepted</option>
                  <option value="Open">Open</option>
                  <option value="In Progress">In Progress</option>
                  <option value="On Hold">On Hold</option>
                  <option value="Re-assign">Re-Assign</option>
                  <option value="Closed">Closed</option>
                </select>

                <div
                  class="text-danger"
                  *ngIf="
                    controls['ticket_status'].invalid &&
                    (controls['ticket_status'].dirty ||
                      controls['ticket_status'].touched)
                  "
                >
                  <small>Please select a Ticket Status.</small>
                </div>
              </div>
              <div class="col-md-4">
                <label class="mb-2">
                  Assigned To <span class="text-danger">*</span>
                </label>
                <mat-select
                  formControlName="assigned_to"
                  placeholder="Select Employee"
                  class="form-control theme-input"
                >
                  <mat-option>
                    <ngx-mat-select-search
                      [(ngModel)]="searchTicketTechnicianValue"
                      [ngModelOptions]="{ standalone: true }"
                      (input)="filterTechnicianAssignTo()"
                      placeholderLabel="Search Employee"
                      noEntriesFoundLabel="No result found"
                    ></ngx-mat-select-search>
                  </mat-option>
                  <mat-option
                    *ngFor="let source of filteredTicketTechnicianList"
                    [value]="source.user_id"
                  >
                    <span>
                      {{ source.user_name | titlecase }}
                    </span>
                  </mat-option>
                </mat-select>
              </div>

              <!-- message -->
              <div class="col-md-8 mb-3">
                <label class="mb-2">Message </label>
                <textarea
                  class="form-control"
                  formControlName="description"
                  placeholder="Message"
                ></textarea>
              </div>
            </div>
            <hr />
            <!-- Ticket Attachments (Multiple) -->
            <div class="card p-3 mt-4">
              <div class="row">
                <div class="col-12">
                  <div
                    class="card-header d-flex justify-content-between align-items-center"
                  >
                    <b>Ticket Attachments </b>
                  </div>
                  <div class="card-body scrollable-body">
                    <div class="row">
                      <div
                        class=""
                        [ngClass]="isEdit ? 'col-md-4' : 'col-md-8'"
                      >
                        <input
                          type="file"
                          class="form-control"
                          formControlName="base64PDF"
                          (change)="onFileSelected($event)"
                          accept=".pdf,.jpg,.png,.jpeg"
                        />
                        <div
                  class="text-danger"
                  *ngIf="
                    controls['base64PDF'].invalid &&
                    (controls['base64PDF'].touched ||
                      controls['base64PDF'].dirty)
                  "
                >
                  <small *ngIf="controls['base64PDF'].errors?.['invalidType']">
                    Only PDF, JPG, JPEG, PNG files are allowed.
                  </small>
                </div>
                      </div>
                      <div class="col-md-8" *ngIf="isEdit">
                        <table
                          class="table table-bordered table-sm align-middle"
                        >
                          <thead class="table-light">
                            <tr>
                              <th style="width: 70px">Sr No.</th>
                              <th style="width: 160px">Date</th>
                              <th>Created By</th>
                              <th>Attachment</th>
                            </tr>
                          </thead>

                          <tbody>
                            <tr
                              *ngFor="
                                let file of allTicketDetails?.ticketAttachHistory;
                                let i = index
                              "
                            >
                              <td class="text-center">
                                {{ i + 1 }}
                              </td>
                              <td style="width: 160px">
                                {{
                                  file.uploaded_at | date : "dd-MM-yyyy hh:mm a"
                                }}
                              </td>
                              <td>
                                {{ file.user_name }}
                              </td>
                              <td>
                                <a
                                  class="cursor-pointer"
                                  (click)="
                                    downloadTicketTicketAttachmentDocument(
                                      file.ticket_attachment_id
                                    )
                                  "
                                  >{{ file.file_path }}</a
                                >
                              </td>
                            </tr>
                            <tr
                              class="fw-bold text-center"
                              *ngIf="
                                allTicketDetails?.ticketAttachHistory.length ===
                                0
                              "
                            >
                              <td colspan="10" class="text-danger">
                                No Data Available
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <hr />
            <!-- Agent Remark -->
            <div class="card p-3">
              <div class="row">
                <div class="col-12">
                  <div
                    class="card-header d-flex justify-content-between align-items-center"
                  >
                    <b>Agent Remark</b>
                  </div>

                  <div class="card-body scrollable-body">
                    <div class="row">
                      <!-- <div class="col-md-4">
                        <label class="mb-2">
                          Assigned To <span class="text-danger">*</span>
                        </label>
                        <mat-select
                          formControlName="assigned_to"
                          placeholder="Select Employee"
                          class="form-control theme-input"
                        >
                          <mat-option>
                            <ngx-mat-select-search
                              [(ngModel)]="searchTicketTechnicianValue"
                              [ngModelOptions]="{ standalone: true }"
                              (input)="filterTechnicianAssignTo()"
                              placeholderLabel="Search Employee"
                              noEntriesFoundLabel="No result found"
                            ></ngx-mat-select-search>
                          </mat-option>
                          <mat-option
                            *ngFor="let source of filteredTicketTechnicianList"
                            [value]="source.user_id"
                          >
                            <span>
                              {{
                                source.user_name
                                  | titlecase
                              }}
                            </span>
                          </mat-option>
                        </mat-select>
                      </div> -->
                      <!-- remarks -->
                      <div
                        class="mb-3"
                        [ngClass]="isEdit ? 'col-md-4' : 'col-md-8'"
                      >
                        <label class="mb-2"
                          >Remark <span class="text-danger">*</span></label
                        >
                        <input
                          type="text"
                          class="form-control"
                          formControlName="remarks"
                          placeholder="Remark"
                          [ngClass]="{
                            'is-invalid':
                              controls['remarks'].invalid &&
                              (controls['remarks'].dirty ||
                                controls['remarks'].touched)
                          }"
                        />
                        <div
                          class="text-danger"
                          *ngIf="
                            controls['remarks'].invalid &&
                            (controls['remarks'].dirty ||
                              controls['remarks'].touched)
                          "
                        >
                          <div *ngIf="controls['remarks'].errors?.['required']">
                            <small>Remarks is Required</small>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-8" *ngIf="isEdit">
                        <table
                          class="table table-bordered table-sm align-middle"
                        >
                          <thead class="table-light">
                            <tr>
                              <th style="width: 70px">Sr No.</th>
                              <th style="width: 160px">Date</th>
                              <th>Created By</th>
                              <th>Agent Remark</th>
                            </tr>
                          </thead>

                          <tbody>
                            <tr
                              *ngFor="
                                let member of allTicketDetails?.ticketStatusHistory;
                                let i = index
                              "
                            >
                              <td class="text-center">
                                {{ i + 1 }}
                              </td>
                              <td style="width: 160px">
                                {{ member.cts | date : "dd-MM-yyyy hh:mm a" }}
                              </td>
                              <td>
                                {{ member.user_name }}
                              </td>
                              <td>
                                <p [innerHTML]="member.remarks || '--'"></p>
                              </td>
                            </tr>
                            <tr
                              class="fw-bold text-center"
                              *ngIf="
                                allTicketDetails?.ticketStatusHistory.length ===
                                0
                              "
                            >
                              <td colspan="10" class="text-danger">
                                No Data Available
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <!-- remarks -->
                      <!-- <div class="col-md-4 mb-3">
                <label class="mb-2">Remark </label>
                <input
                  type="text"
                  class="form-control"
                  formControlName="remarks"
                  placeholder="Remark"
                  [ngClass]="{
                    'is-invalid':
                      controls['remarks'].invalid &&
                      (controls['remarks'].dirty || controls['remarks'].touched)
                  }"
                />
              </div> -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <hr />
            <div class="mt-3">
              <button
                type="submit"
                class="btn btn-primary px-4 btn-sm fw-bold"
                (click)="submit()"
              >
                {{ isEdit ? "Update" : "Submit" }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
